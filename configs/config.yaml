# configs/silver_schemas.yaml

# Commented out sections are in API schema but data not currently available

silver:
  fct_flights:
    final_column_order:
      # --- Foreign Keys (created on the fly, no original name) ---
      - name: flight_composite_pk
      - name: departure_airport_bk
      - name: arrival_airport_bk
      - name: airline_bk
      - name: aircraft_bk
      - name: departure_runway_version_bk
      - name: arrival_runway_version_bk

      # --- Flight Identity ---
      - name: number
        alias: flight_number
      - name: call_sign
        alias: flight_callsign
      - name: status
        alias: flight_status
      - name: codeshare_status
      - name: is_cargo

      # --- Departure Timestamps ---
      - name: departure_scheduled_time_utc
        alias: dep_scheduled_at_utc
      - name: departure_revised_time_utc
        alias: dep_revised_at_utc
      # - name: departure_predicted_time_utc
      #   alias: dep_predicted_at_utc
      - name: departure_runway_time_utc
        alias: dep_runway_at_utc
      - name: departure_scheduled_time_local_ntz
        alias: dep_scheduled_at_local_ntz
      - name: departure_revised_time_local_ntz
        alias: dep_revised_at_local_ntz
      # - name: departure_predicted_time_local_ntz
      #   alias: dep_predicted_at_local_ntz
      - name: departure_runway_time_local_ntz
        alias: dep_runway_at_local_ntz
      - name: dep_local_timezone

      # --- Arrival Timestamps ---
      - name: arrival_scheduled_time_utc
        alias: arr_scheduled_at_utc
      - name: arrival_revised_time_utc
        alias: arr_revised_at_utc
      # - name: arrival_predicted_time_utc
      #   alias: arr_predicted_at_utc
      - name: arrival_runway_time_utc
        alias: arr_runway_at_utc
      - name: arrival_scheduled_time_local_ntz
        alias: arr_scheduled_at_local_ntz
      - name: arrival_revised_time_local_ntz
        alias: arr_revised_at_local_ntz
      # - name: arrival_predicted_time_local_ntz
      #   alias: arr_predicted_at_local_ntz
      - name: arrival_runway_time_local_ntz
        alias: arr_runway_at_local_ntz
      - name: arr_local_timezone # This column is created in the Spark job

      # --- Operational Details ---
      - name: departure_terminal
        alias: dep_terminal
      - name: departure_check_in_desk
        alias: dep_checkin_desk
      - name: departure_gate
        alias: dep_gate
      # - name: departure_baggage_belt
      #   alias: dep_baggage_belt
      - name: departure_runway
        alias: dep_runway
      - name: departure_quality
        alias: dep_quality

      - name: arrival_terminal
        alias: arr_terminal
      # - name: arrival_check_in_desk
      #   alias: arr_checkin_desk
      - name: arrival_gate
        alias: arr_gate
      - name: arrival_baggage_belt
        alias: arr_baggage_belt
      - name: arrival_runway
        alias: arr_runway
      - name: arrival_quality
        alias: arr_quality
        
      # --- Live Location (simplified names) ---
      - name: location_reported_at_utc
        alias: last_location_reported_at_utc
      - name: location_lat
        alias: latitude
      - name: location_lon
        alias: longitude
      - name: location_altitude_feet
        alias: altitude_ft
      - name: location_ground_speed_kt
        alias: ground_speed_kts
      - name: location_true_track_deg
        alias: true_track_deg

      # --- Metadata for Lineage ---
      - name: _ingested_at
      - name: _inserted_at
      - name: ingestion_hour

  
  dim_airports_detailed:
    final_column_order:
      # No alias needed, name is good as is
      - name: iata 
      - name: icao
      
      # Rename for clarity and consistency
      - name: short_name
      - name: full_name
      - name: municipality_name
      - name: location_lat
        alias: latitude
      - name: location_lon
        alias: longitude
      - name: elevation_feet
      - name: country_code
      - name: country_name
      - name: continent_code
      - name: continent_name
      - name: time_zone

  dim_airports:
    merge_strategy:
      country_name: prefer_arriving
      airport_time_zone: prefer_arriving


  dim_runways:
    merge_strategy:
      has_lighting: -1
      is_closed: -1

    final_column_order:
      # --- Keys and Identifiers ---
      # No alias needed, this is the Foreign Key to dim_airports
      # - name: runway_business_key
      - name: runway_bk
      
      - name: airport_bk
      - name: name
        alias: runway_name

      # --- Core Attributes ---
      - name: true_hdg
        alias: true_heading
      - name: surface
      - name: has_lighting
      - name: is_closed

      # --- Physical Dimensions ---
      # Standardize on feet, the aviation industry standard, and drop all others
      - name: length_feet
      - name: width_feet
      - name: displaced_threshold_feet

      # --- Geospatial ---
      # Rename for consistency with dim_airports
      - name: location_lat
        alias: latitude
      - name: location_lon
        alias: longitude

      - name: _ingested_at
      - name: _inserted_at

  dim_airports_openflights:
    merge_strategy:
      airport_iata: prefer_arriving
      airport_icao: prefer_arriving
      airport_gps: prefer_arriving
      airport_local_code: prefer_arriving
      airport_name: prefer_arriving
      municipality_name: prefer_arriving
      iso_region: prefer_arriving
      iso_country: prefer_arriving
      latitude: prefer_arriving
      longitude: prefer_arriving
      elevation_feet: prefer_arriving
      airport_type: prefer_arriving
      scheduled_service: prefer_arriving

    final_column_order:
      - name: airport_bk
      - name: iata_code
        alias: airport_iata
      - name: icao_code
        alias: airport_icao
      - name: gps_code
        alias: airport_gps
      - name: local_code
        alias: airport_local_code
      - name: name
        alias: airport_name
      - name: municipality
        alias: municipality_name
      - name: iso_region
      - name: iso_country
      - name: latitude_deg
        alias: latitude
      - name: longitude_deg
        alias: longitude
      - name: elevation_ft
        alias: elevation_feet
      - name: type
        alias: airport_type
      - name: scheduled_service

      - name: _ingested_at
      - name: _inserted_at

  dim_runways_openflights:
    merge_strategy:
      surface: -1
      has_lighting: -1
      is_closed: -1
      length_feet: 0
      width_feet: 0
      displaced_threshold_feet: 0
      elevation_feet: 0
      runway_end_type: -1
      runway_name: -1

    final_column_order:
      - name: runway_bk
      - name: airport_bk
      - name: runway_name

      - name: true_heading
      - name: surface
      - name: has_lighting
      - name: is_closed
      - name: length_feet
      - name: width_feet
      - name: displaced_threshold_feet
      - name: latitude
      - name: longitude
      - name: elevation_feet
      - name: runway_end_type

      - name: _ingested_at
      - name: _inserted_at

  dim_regions:
    merge_strategy:
      local_code: prefer_arriving
      region_name: prefer_arriving
      continent_code: prefer_arriving
      iso_country: prefer_arriving
      country_name: prefer_arriving

    final_column_order:
      - name: regions.code
        alias: region_code
      - name: local_code
      - name: regions.name
        alias: region_name
      - name: regions.continent
        alias: continent_code
      - name: iso_country
      - name: country_name

      - name: _ingested_at
      - name: _inserted_at


gold:
  fct_flights_intermediate:
    final_column_order:
      # --- Keys ---
      # Natural Key for lineage and potential joins.
      - name: flight_composite_pk
      
      # --- Foreign Keys (The result of your dimension lookups) ---
      # Keys from the new junk/combo dimensions exist now.
      - name: flight_details_sk
      - name: quality_combo_sk
      # Keys from the original Silver dimensions are carried over.
      - name: departure_airport_bk
      - name: arrival_airport_bk
      - name: airline_bk
      - name: aircraft_bk
      # Nullable FKs have been resolved. They may still be NULL at this stage,
      # or you might have already coalesced them to -1. Let's assume they are still NULL for clarity.
      - name: departure_runway_version_bk
      - name: arrival_runway_version_bk

      # --- Degenerate Dimensions (Carried over from Silver) ---
      - name: flight_number
      - name: flight_callsign
      - name: dep_terminal
      - name: dep_checkin_desk
      - name: dep_gate
      - name: arr_terminal
      - name: arr_gate
      - name: arr_baggage_belt
      - name: dep_local_timezone
      - name: arr_local_timezone

      # --- Measures / Facts (Carried over from Silver) ---
      # All the raw timestamps are needed to calculate delays/durations.
      - name: dep_scheduled_at_utc
      - name: dep_revised_at_utc
      - name: dep_runway_at_utc
      - name: arr_scheduled_at_utc
      - name: arr_revised_at_utc
      - name: arr_runway_at_utc
      - name: last_location_reported_at_utc
      - name: latitude
      - name: longitude
      - name: altitude_ft
      - name: ground_speed_kts
      - name: true_track_deg
      
      # --- Metadata ---
      - name: _ingested_at
      - name: _inserted_at
      - name: ingestion_hour
      - name: flight_date
